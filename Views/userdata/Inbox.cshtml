@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}


@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    ViewData["Title"] = "Index";
    Layout = "userLayout";
}
@using System.Security.Claims;
@model online_sms.Models.Message;
@model IEnumerable<Message>
<div class="main-container" id="container">

    <!-- partial:index.partial.html -->
    <div class="container-fluid clearfix">
        <div class="row" style="padding: 20px;">
        <div class="col-md-4" >

        <div class="people-list" id="people-list">
            <div class="search">
                <input type="text" placeholder="search" />
                <i class="fa fa-search"></i>
            </div>
            <ul class="list">

                        @if (ViewBag.Users != null)
                        {
                            foreach (var user in ViewBag.Users)
                            {
                                <li class="clearfix" data-userid="@user.UserId">
                                    <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/195612/chat_avatar_01.jpg" alt="avatar" />
                                    <div class="about">
                                        <div class="name">@user.Username</div>
                                        <div class="status">
                                            <i class="fa fa-circle online"></i> online
                                        </div>
                                    </div>
                                </li>
                            }
                        }

              
            </ul>
        </div>
        </div>
            <div class="col-md-8">
        <div class="chat">
            <div class="chat-header clearfix">
                <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/195612/chat_avatar_01_green.jpg" alt="avatar" />

                <div class="chat-about">
                    <div class="chat-with">Chat with Vincent Porter</div>
                    <div class="chat-num-messages">already 1 902 messages</div>
                </div>
                <i class="fa fa-star"></i>
            </div> <!-- end chat-header -->

            <div class="chat-history">
               <ul>
    @foreach (var message in Model)
    {
        <li class="clearfix @(message.SenderUserId == User.FindFirst(ClaimTypes.NameIdentifier).Value ? "me" : "other")">
            <div class="message-data @(message.SenderUserId == User.FindFirst(ClaimTypes.NameIdentifier).Value ? "align-right" : "")">
                <span class="message-data-time">@message.SentAt.ToString("hh:mm tt")</span> &nbsp; &nbsp;
                <span class="message-data-name">@(message.SenderUserId == User.FindFirst(ClaimTypes.NameIdentifier).Value ? "You" : "Other")</span> 
                <i class="fa fa-circle @(message.SenderUserId == User.FindFirst(ClaimTypes.NameIdentifier).Value ? "me" : "other")"></i>
            </div>
            <div class="message @(message.SenderUserId == User.FindFirst(ClaimTypes.NameIdentifier).Value ? "my-message" : "other-message float-right")">
                @message.MessageText
            </div>
        </li>
    }
</ul>

            </div> <!-- end chat-history -->

               <form asp-action="Inbox" >
            <div class="chat-message clearfix">
                            @if (User.Identity.IsAuthenticated)
                            {                             
                                <input type="hidden" asp-for="SenderUserId" value=" @User.FindFirst(ClaimTypes.Sid)?.Value" />
                            }
                            <textarea  asp-for="MessageText" id="message-to-send" placeholder="Type your message" rows="3"></textarea>

                <i class="fa fa-file-o"></i> &nbsp;&nbsp;&nbsp;
                <i class="fa fa-file-image-o"></i>

                <button>Send</button>

            </div> <!-- end chat-message -->
               </form>

        </div> <!-- end chat -->
        </div>
        </div>
    </div> <!-- end container -->

    <script id="message-template" type="text/x-handlebars-template">
        <li class="clearfix">
          <div class="message-data align-right">
            <span class="message-data-time" >{{time}}, Today</span> &nbsp; &nbsp;
            <span class="message-data-name" >Olia</span> <i class="fa fa-circle me"></i>
          </div>
          <div class="message other-message float-right">
            {{messageOutput}}
          </div>
        </li>
    </script>

    <script id="message-response-template" type="text/x-handlebars-template">
        <li>
          <div class="message-data">
            <span class="message-data-name"><i class="fa fa-circle online"></i> Vincent</span>
            <span class="message-data-time">{{time}}, Today</span>
          </div>
          <div class="message my-message">
            {{response}}
          </div>
        </li>
    </script>

</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


<script>
    $(document).ready(function () {
        // Handle user click
        $('.clearfix').click(function () {
            var userId = $(this).data('userid');
            var username = $(this).find('.name').text();

            $('#receiver-user-id').val(userId);
            $('#chat-with').text('Chat with ' + username);

            // Load chat history for the selected user
            $.get('/Chat/GetChatHistory', { receiverId: userId }, function (data) {
                $('#chat-history').html(data);
            });
        });

        // Handle message sending
        $('#message-form').submit(function (e) {
            e.preventDefault();

            var formData = $(this).serialize();

            $.post('/Chat/Inbox', formData, function () {
                // Reload chat history after sending the message
                var receiverId = $('#receiver-user-id').val();
                $.get('/Chat/GetChatHistory', { receiverId: receiverId }, function (data) {
                    $('#chat-history').html(data);
                });

                // Clear message textarea
                $('#message-to-send').val('');
            });
        });
    });
</script>

